
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>laboratory &#8212; Laboratory 0.1 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for laboratory</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">config</span>
<span class="kn">import</span> <span class="nn">plotting</span>
<span class="kn">import</span> <span class="nn">utils</span>
<span class="kn">import</span> <span class="nn">drivers</span>
<span class="kn">import</span> <span class="nn">data</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">lab_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="Setup"><a class="viewcode-back" href="../laboratory.html#laboratory.Setup">[docs]</a><span class="k">class</span> <span class="nc">Setup</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets up the laboratory</span>

<span class="sd">    =============== ===========================================================</span>
<span class="sd">    Attributes      Description</span>
<span class="sd">    =============== ===========================================================</span>
<span class="sd">    data            houses lab data during measurements or after parseing</span>
<span class="sd">    logger          creates a logger for error reporting</span>
<span class="sd">    plot            contains different plotting tools for data visualisation</span>
<span class="sd">    command         contains the drivers for controlling instrumentation</span>
<span class="sd">    =============== ===========================================================</span>

<span class="sd">    ================= ===========================================================</span>
<span class="sd">    Public Methods    Description</span>
<span class="sd">    ================= ===========================================================</span>
<span class="sd">    device_status     checks the status of all connected devices</span>
<span class="sd">    get_gas           retrieves and saves data from a single mass flow controller</span>
<span class="sd">    get_impedance     retrieves and saves complex impedance data from the LCR meter</span>
<span class="sd">    get_temp          retrieves and saves temperature data from the furnace</span>
<span class="sd">    get_thermo        retrieves and saves thermopower data from the DAQ</span>
<span class="sd">    load_data         will parse a datafile and store in &#39;data&#39; structure for post-</span>
<span class="sd">                      processing and visualisation</span>
<span class="sd">    load_frequencies  loads a set of frequencies into Data object</span>
<span class="sd">    load_instruments  connects to all available instruments</span>
<span class="sd">    run               begins a new set of laboratory measurements</span>
<span class="sd">    ================= ===========================================================</span>

<span class="sd">    ================= ===========================================================</span>
<span class="sd">    Private Methods   Description</span>
<span class="sd">    ================= ===========================================================</span>
<span class="sd">    _break_loop       determines when the main measurement loop should break and start a</span>
<span class="sd">                      new step</span>
<span class="sd">    _count_down       controls the count down timer displayed between measurements</span>
<span class="sd">    _measurement_loop main measurement loop of the program that retrieves and saves</span>
<span class="sd">                      data</span>
<span class="sd">    _progress_bar     controls the progress bar displayed during measurements</span>
<span class="sd">    ================= ===========================================================</span>

<span class="sd">    :Example:</span>

<span class="sd">    &gt;&gt;&gt; import Laboratory</span>
<span class="sd">    &gt;&gt;&gt; lab = Laboratory.Setup()</span>
<span class="sd">    &gt;&gt;&gt; lab.run(&#39;some_controlfile&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;-------------------------------------------&#39;</span><span class="p">)</span>
        <span class="c1"># self.plot = LabPlots()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dlogger</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delayed_start</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_instruments</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Data</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_frequencies</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">=</span> <span class="n">plotting</span><span class="o">.</span><span class="n">LabPlots</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span>

    <span class="nd">@debug</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">delayed_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Starts the experiment at a given time the next day. Can be set to any 24 hour time in string format.</span>

<span class="sd">        :Example:</span>

<span class="sd">        &gt;&gt;&gt; import Laboratory</span>
<span class="sd">        &gt;&gt;&gt; lab = Laboratory.Setup()</span>
<span class="sd">        &gt;&gt;&gt; lab.delayed_start = &#39;0900&#39; #start at 9am the following day</span>
<span class="sd">        &gt;&gt;&gt; lab.run(&#39;some_controlfile&#39;)</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delayed_start</span>

    <span class="nd">@delayed_start</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">delayed_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">start_time</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delayed_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                            <span class="n">hour</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">start_time</span><span class="p">[:</span><span class="mi">2</span><span class="p">]),</span>
                            <span class="n">minute</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">start_time</span><span class="p">[</span><span class="mi">2</span><span class="p">:]),</span>
                            <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span>
                            <span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="Setup.load_data"><a class="viewcode-back" href="../laboratory.html#laboratory.Setup.load_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        loads a previous data file for processing and analysis</span>

<span class="sd">        :param filename: path to data file</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;txt&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">parse_datafile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pkl&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_obj</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unsupported filetype! Must be .txt or .pkl&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span></div>

<div class="viewcode-block" id="Setup.load_frequencies"><a class="viewcode-back" href="../laboratory.html#laboratory.Setup.load_frequencies">[docs]</a>    <span class="k">def</span> <span class="nf">load_frequencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">min</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">min_freq</span><span class="p">,</span><span class="nb">max</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_freq</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads an np.array of frequency values specified by either min, max and n or a file containing a list of frequencies specified by filename.</span>

<span class="sd">        :param filename: name of file containing frequencies</span>
<span class="sd">        :type filename: str</span>

<span class="sd">        :param n: number of desired frequencies</span>
<span class="sd">        :type n: int</span>

<span class="sd">        :param min: minimum frequency (Hz) - may not be below default value of 20 Hz</span>
<span class="sd">        :type min: int,float</span>

<span class="sd">        :param max: maximum frequency (Hz) - may not exceed default value of 2*10^6 Hz</span>
<span class="sd">        :type max: int,float</span>

<span class="sd">        :param log: specifies whether array is created in linear or log space. default to logspace</span>
<span class="sd">        :type log: boolean</span>

<span class="sd">        :Example:</span>

<span class="sd">        &gt;&gt;&gt; lab = Laboratory.Setup()</span>
<span class="sd">        &gt;&gt;&gt; lab.load_frequencies(min=1000, max=10000, n=10)</span>
<span class="sd">        &gt;&gt;&gt; print(lab.data.freq)</span>
<span class="sd">        [1000 2000 3000 4000 5000 6000 7000 8000 9000 10000]</span>
<span class="sd">        &gt;&gt;&gt; lab.load_frequencies(min=1000, max=10000, n=10, log=True)</span>
<span class="sd">        &gt;&gt;&gt; print(lab.data.freq)</span>
<span class="sd">        [1000 1291.55 1668.1 2154.43 2782.56 3593.81 4641.59 5994.84 7742.64 10000]&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Creating frequency data...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_frequencies</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span><span class="nb">max</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">log</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="Setup.run"><a class="viewcode-back" href="../laboratory.html#laboratory.Setup.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">controlfile</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        starts a new set of measurements. requires a control file that contains</span>
<span class="sd">        specific instruction for the instruments to follow. see the tutorial section</span>
<span class="sd">        for help setting up a control file.</span>

<span class="sd">        :param controlfile: path to control file</span>
<span class="sd">        :type controlfile: str</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">preflight_checklist</span><span class="p">(</span><span class="n">controlfile</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;Couldn</span><span class="se">\&#39;</span><span class="s1">t start the experiment&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delayed_start</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Experiment will start at </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayed_start</span><span class="p">,</span><span class="s1">&#39;%H:%M on %b </span><span class="si">%d</span><span class="s1"> &#39;</span><span class="p">)))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">delayed_start</span><span class="o">-</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">send_email</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">email</span><span class="p">,</span><span class="n">utils</span><span class="o">.</span><span class="n">Messages</span><span class="o">.</span><span class="n">delayed_start</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayed_start</span><span class="p">,</span><span class="s1">&#39;%H:%M&#39;</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Resuming...&#39;</span><span class="p">)</span>

        <span class="c1"># iterate through control file until finished</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlfile</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;============================&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Step </span><span class="si">{}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;============================&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="c1"># self._print_df(step)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Estimated completion time for current step: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">step</span><span class="o">.</span><span class="n">est_total_mins</span><span class="p">),</span><span class="s1">&#39;%H:%M %A, %b </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)))</span>

            <span class="c1">#set the required heating rate if a change is needed</span>
            <span class="k">if</span> <span class="n">step</span><span class="o">.</span><span class="n">heat_rate</span> <span class="o">-</span> <span class="n">step</span><span class="o">.</span><span class="n">previous_heat_rate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">furnace</span><span class="o">.</span><span class="n">heating_rate</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">heat_rate</span><span class="p">)</span>
            <span class="c1">#set the required temperature if a change is needed</span>
            <span class="k">if</span> <span class="n">step</span><span class="o">.</span><span class="n">target_temp</span> <span class="o">-</span> <span class="n">step</span><span class="o">.</span><span class="n">previous_target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">furnace</span><span class="o">.</span><span class="n">setpoint_1</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">find_indicated</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">target_temp</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="c1">#start measurement cycle</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="s1">&#39;step&#39;</span><span class="p">,</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_measurement_loop</span><span class="p">(</span><span class="n">step</span><span class="p">):</span>     <span class="c1">#enter the main measurement loop</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Step </span><span class="si">{}</span><span class="s1"> complete!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlfile</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">est_completion</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">step</span><span class="o">.</span><span class="n">est_total_mins</span><span class="p">),</span><span class="s1">&#39;%H:%M %A, %b </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">send_email</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">email</span><span class="p">,</span><span class="n">utils</span><span class="o">.</span><span class="n">Messages</span><span class="o">.</span><span class="n">step_complete</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">controlfile</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;target_temp&#39;</span><span class="p">],</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">est_completion</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;Something wen</span><span class="se">\&#39;</span><span class="s1">t wrong!&#39;</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shut_down</span><span class="p">()</span></div>

<div class="viewcode-block" id="Setup._measurement_loop"><a class="viewcode-back" href="../laboratory.html#laboratory.Setup._measurement_loop">[docs]</a>    <span class="k">def</span> <span class="nf">_measurement_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">step</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is the main measurement loop of the program. All data is accessed and saved from within this loop</span>

<span class="sd">        :param step: a single row from the control file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">step_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">7</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">freq</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">loop_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

            <span class="c1">#get some measurements</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">daq</span><span class="o">.</span><span class="n">get_temp</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Collecting measurements @ </span><span class="si">{:.1f}</span><span class="s1"> degC...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_temp</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_progress_bar</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;Collecting furnace data...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_temp</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">target_temp</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_progress_bar</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;Collecting gas data...&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">gas</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;h2&#39;</span><span class="p">,</span><span class="s1">&#39;co2&#39;</span><span class="p">,</span><span class="s1">&#39;co_a&#39;</span><span class="p">,</span><span class="s1">&#39;co_b&#39;</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_gas</span><span class="p">(</span><span class="n">gas</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_progress_bar</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;Collecting thermopower data...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_thermopower</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_progress_bar</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39;Collecting impedance data...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_impedance</span><span class="p">()</span>

            <span class="c1">#setting the required gas mix</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_progress_bar</span><span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">freq</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span><span class="s1">&#39;Setting required gas levels...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_fugacity</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span><span class="n">step</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span><span class="n">step</span><span class="o">.</span><span class="n">fo2_gas</span><span class="p">)</span>

            <span class="c1">#save a pickle object as backup</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_progress_bar</span><span class="p">(</span><span class="mi">6</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">freq</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span><span class="s1">&#39;Saving backup file...&#39;</span><span class="p">)</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">save_obj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_progress_bar</span><span class="p">(</span><span class="mi">7</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">freq</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span><span class="s1">&#39;Complete!&#39;</span><span class="p">)</span>

            <span class="c1">#wait until the interval has expired before starting new measurements</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_count_down</span><span class="p">(</span><span class="n">loop_start</span><span class="p">,</span><span class="n">step</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">device_status</span><span class="p">():</span> <span class="k">return</span> <span class="kc">False</span>   <span class="c1">#check to make sure everything is connected</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_break_loop</span><span class="p">(</span><span class="n">step</span><span class="p">,</span><span class="n">step_start</span><span class="p">):</span> <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Setup.device_status"><a class="viewcode-back" href="../laboratory.html#laboratory.Setup.device_status">[docs]</a>    <span class="k">def</span> <span class="nf">device_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks the status of all devices. If desired, this function can send an email when something has become disconnected</span>

<span class="sd">        :returns: True if all devices are connected and False if any are disconnected</span>
<span class="sd">        :rtype: Boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">device_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;furnace&#39;</span><span class="p">,</span><span class="s1">&#39;motor&#39;</span><span class="p">,</span><span class="s1">&#39;daq&#39;</span><span class="p">,</span><span class="s1">&#39;lcr&#39;</span><span class="p">,</span><span class="s1">&#39;mfc&#39;</span><span class="p">]</span>

        <span class="n">dev_errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">device_list</span><span class="p">:</span>
            <span class="n">device_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">device</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">device_obj</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;We</span><span class="se">\&#39;</span><span class="s1">ve got a problem!&#39;</span><span class="p">)</span>
                <span class="n">dev_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dev_errors</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">send_email</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">email</span><span class="p">,</span><span class="n">utils</span><span class="o">.</span><span class="n">Messages</span><span class="o">.</span><span class="n">device_error</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dev_errors</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Could not send email for &#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Setup.reconnect"><a class="viewcode-back" href="../laboratory.html#laboratory.Setup.reconnect">[docs]</a>    <span class="k">def</span> <span class="nf">reconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attempts to reconnect to any instruments that have been disconnected&quot;&quot;&quot;</span>
        <span class="n">drivers</span><span class="o">.</span><span class="n">_reconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Setup.load_instruments"><a class="viewcode-back" href="../laboratory.html#laboratory.Setup.load_instruments">[docs]</a>    <span class="k">def</span> <span class="nf">load_instruments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads all the laboratory instruments. Called automatically when calling Setup() without a filename specified.</span>

<span class="sd">        :returns: lcr, daq, mfc, furnace, motor</span>
<span class="sd">        :rtype: instrument objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Establishing connection with instruments...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcr</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">daq</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mfc</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">furnace</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">motor</span> <span class="o">=</span> <span class="n">drivers</span><span class="o">.</span><span class="n">_load_instruments</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Setup.set_fugacity"><a class="viewcode-back" href="../laboratory.html#laboratory.Setup.set_fugacity">[docs]</a>    <span class="k">def</span> <span class="nf">set_fugacity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">buffer</span><span class="p">,</span><span class="n">offset</span><span class="p">,</span><span class="n">gas_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the correct gas ratio for the given buffer. Percentage offset from a given buffer can be specified by &#39;offset&#39;. Type of gas to be used for calculations is specified by gas_type.</span>

<span class="sd">        :param buffer: buffer type (see table for input options)</span>
<span class="sd">        :type buffer: str</span>

<span class="sd">        :param offset: percentage offset from specified buffer</span>
<span class="sd">        :type offset: float, int</span>

<span class="sd">        :param gas_type: gas type to use for calculating ratio - can be either &#39;h2&#39; or &#39;co&#39;</span>
<span class="sd">        :type pressure: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Recalculating required co2:</span><span class="si">{:s}</span><span class="s1"> mix...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gas_type</span><span class="p">))</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">daq</span><span class="o">.</span><span class="n">get_temp</span><span class="p">()</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">fo2p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mfc</span><span class="o">.</span><span class="n">fo2_buffer</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="n">buffer</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">gas_type</span> <span class="o">==</span> <span class="s1">&#39;h2&#39;</span><span class="p">:</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mfc</span><span class="o">.</span><span class="n">fugacity_h2</span><span class="p">(</span><span class="n">fo2p</span><span class="p">,</span><span class="n">temp</span><span class="p">)</span>
            <span class="n">h2</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">co2</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">h2</span><span class="o">*</span><span class="n">ratio</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;    </span><span class="si">{:.5f}</span><span class="s1">:1 required to maintain +</span><span class="si">{:.2%}</span><span class="s1"> the &quot;</span><span class="si">{:s}</span><span class="s1">&quot; buffer @ </span><span class="si">{:.1f}</span><span class="s1"> degrees Celsius&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span><span class="n">offset</span><span class="p">,</span><span class="n">buffer</span><span class="p">,</span><span class="n">temp</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;    Setting CO2 to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">co2</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="s1">&#39;delete_me&#39;</span><span class="p">,</span><span class="n">co2</span><span class="p">,</span><span class="n">gastype</span><span class="o">=</span><span class="s1">&#39;co2&#39;</span><span class="p">)</span>
            <span class="c1"># self.mfc.co2.set_massflow()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;    Setting H2 to </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h2</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="s1">&#39;delete_me&#39;</span><span class="p">,</span><span class="n">h2</span><span class="p">,</span><span class="n">gastype</span><span class="o">=</span><span class="s1">&#39;h2&#39;</span><span class="p">)</span>
            <span class="c1"># self.mfc.h2.set_massflow()</span>

        <span class="k">elif</span> <span class="n">gas_type</span> <span class="o">==</span> <span class="s1">&#39;co&#39;</span><span class="p">:</span>

            <span class="n">ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mfc</span><span class="o">.</span><span class="n">fugacity_co</span><span class="p">(</span><span class="n">fo2p</span><span class="p">,</span><span class="n">temp</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;    </span><span class="si">{:.5f}</span><span class="s1">:1 required to maintain +</span><span class="si">{:.2%}</span><span class="s1"> the &quot;</span><span class="si">{:s}</span><span class="s1">&quot; buffer @ </span><span class="si">{:.1f}</span><span class="s1"> degrees Celsius&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span><span class="n">offset</span><span class="p">,</span><span class="n">buffer</span><span class="p">,</span><span class="n">temp</span><span class="p">))</span>

            <span class="n">co2</span> <span class="o">=</span> <span class="mi">50</span>    <span class="c1">#sets 50 sccm as the optimal co2 flow rate</span>
            <span class="k">if</span> <span class="n">co2</span><span class="o">/</span><span class="n">ratio</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">:</span>
                <span class="n">co2</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mi">20</span><span class="o">*</span><span class="n">ratio</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">co</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">co2</span><span class="o">/</span><span class="n">ratio</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">co_a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">co2</span><span class="o">/</span><span class="n">ratio</span><span class="p">)</span>
            <span class="n">co_b</span> <span class="o">=</span> <span class="n">co</span> <span class="o">-</span> <span class="n">co_a</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;    Setting CO2 to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">co2</span><span class="p">))</span>
            <span class="c1"># self.mfc.co2.set_massflow(co2)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="s1">&#39;delete_me&#39;</span><span class="p">,</span><span class="n">co2</span><span class="p">,</span><span class="n">gastype</span><span class="o">=</span><span class="s1">&#39;co2&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;    Setting CO_a = </span><span class="si">{0:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">co_a</span><span class="p">))</span>
            <span class="c1"># self.mfc.co_a.set_massflow(co_a)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="s1">&#39;delete_me&#39;</span><span class="p">,</span><span class="n">co_a</span><span class="p">,</span><span class="n">gastype</span><span class="o">=</span><span class="s1">&#39;co_a&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;    Setting CO_b = </span><span class="si">{0:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">co_b</span><span class="p">))</span>
            <span class="c1"># self.mfc.co_b.set_massflow(co_b)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="s1">&#39;delete_me&#39;</span><span class="p">,</span><span class="n">co_b</span><span class="p">,</span><span class="n">gastype</span><span class="o">=</span><span class="s1">&#39;co_b&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Incorrect gas type specified!&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Setup.get_gas"><a class="viewcode-back" href="../laboratory.html#laboratory.Setup.get_gas">[docs]</a>    <span class="k">def</span> <span class="nf">get_gas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">gas_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets data from the mass flow controller specified by gas_type and saves to Data structure and file</span>

<span class="sd">        :param gas_type: type of gas to use when calculating ratio (either &#39;h2&#39; or &#39;co&#39;)</span>
<span class="sd">        :type gas_type: str</span>

<span class="sd">        :returns: [mass_flow, pressure, temperature, volumetric_flow, setpoint]</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Collecting </span><span class="si">{}</span><span class="s1"> data...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gas_type</span><span class="p">))</span>
        <span class="n">gas</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mfc</span><span class="p">,</span><span class="n">gas_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="s1">&#39;gas&#39;</span><span class="p">,</span><span class="n">vals</span><span class="o">=</span><span class="n">gas</span><span class="o">.</span><span class="n">get_all</span><span class="p">(),</span><span class="n">gastype</span><span class="o">=</span><span class="n">gas_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="Setup.get_temp"><a class="viewcode-back" href="../laboratory.html#laboratory.Setup.get_temp">[docs]</a>    <span class="k">def</span> <span class="nf">get_temp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieves the indicated temperature of the furnace and saves to Data structure and file</span>

<span class="sd">        .. note::</span>

<span class="sd">            this is the temperature indicated by the furnace, not the temperature of the sample</span>

<span class="sd">        :param target: target temperature of current step</span>
<span class="sd">        :type target: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Collecting temperature data from furnace...&#39;</span><span class="p">)</span>
        <span class="n">indicated_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">furnace</span><span class="o">.</span><span class="n">indicated</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">indicated_temp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indicated_temp</span> <span class="o">=</span> <span class="n">indicated_temp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="s1">&#39;temperature&#39;</span><span class="p">,[</span><span class="n">target</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">indicated_temp</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">furnace</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">furnace</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Setup.get_thermopower"><a class="viewcode-back" href="../laboratory.html#laboratory.Setup.get_thermopower">[docs]</a>    <span class="k">def</span> <span class="nf">get_thermopower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieves thermopower data from the DAQ and saves to Data structure and file</span>

<span class="sd">        :returns: [thermistor, te1, te2, voltage]</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Collecting thermopower data from DAQ...&#39;</span><span class="p">)</span>
        <span class="n">thermo</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">daq</span><span class="o">.</span><span class="n">get_thermopower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">thermo</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="s1">&#39;thermopower&#39;</span><span class="p">,</span><span class="n">thermo</span><span class="p">)</span></div>

<div class="viewcode-block" id="Setup.get_impedance"><a class="viewcode-back" href="../laboratory.html#laboratory.Setup.get_impedance">[docs]</a>    <span class="k">def</span> <span class="nf">get_impedance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets up the lcr meter and retrieves complex impedance data at all frequencies specified by Data.freq. Data is saved in Data.imp.z and Data.imp.theta as a list of length Data.freq. Values are also saved to the data file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Collecting impedance data from LCR meter...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daq</span><span class="o">.</span><span class="n">toggle_switch</span><span class="p">(</span><span class="s1">&#39;impedance&#39;</span><span class="p">)</span>
        <span class="n">Z</span><span class="p">,</span><span class="n">theta</span> <span class="o">=</span> <span class="p">[],[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">freq</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_progress_bar</span><span class="p">(</span><span class="mi">4</span><span class="o">+</span><span class="n">i</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span><span class="s1">&#39;Collecting impedance data...&#39;</span><span class="p">)</span>

            <span class="n">complexZ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcr</span><span class="o">.</span><span class="n">get_complexZ</span><span class="p">()</span>    <span class="c1">#returns one line for each frequency</span>
            <span class="k">if</span> <span class="n">complexZ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="mf">9.9e+37</span><span class="p">:</span> <span class="n">complexZ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">complexZ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="mf">9.9e+37</span><span class="p">:</span> <span class="n">complexZ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dlogger</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dlogger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;Z </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">complexZ</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">complexZ</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">Z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">complexZ</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">theta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">complexZ</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="s1">&#39;impedance&#39;</span><span class="p">,[</span><span class="n">Z</span><span class="p">,</span><span class="n">theta</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daq</span><span class="o">.</span><span class="n">toggle_switch</span><span class="p">(</span><span class="s1">&#39;thermo&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcr</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Successfully collected impedance data&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Setup.save_data"><a class="viewcode-back" href="../laboratory.html#laboratory.Setup.save_data">[docs]</a>    <span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">val_type</span><span class="p">,</span><span class="n">vals</span><span class="p">,</span><span class="n">gastype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes input values and saves to both the current Data object and an external file</span>

<span class="sd">        :param val_type: type of measurement being saved</span>
<span class="sd">        :type val_type: str</span>

<span class="sd">        :param vals: the required values suitable to that specified by val_type</span>
<span class="sd">        :type vals: list</span>

<span class="sd">        :param gastype: [optional] required when saving gas data</span>
<span class="sd">        :type gastype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Saving </span><span class="si">{}</span><span class="s1"> data to file&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val_type</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">val_type</span> <span class="o">==</span> <span class="s1">&#39;gas&#39;</span><span class="p">:</span>
            <span class="n">gas</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">gas</span><span class="p">,</span><span class="n">gastype</span><span class="p">)</span>
            <span class="n">gas</span><span class="o">.</span><span class="n">mass_flow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">gas</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">gas</span><span class="o">.</span><span class="n">temperature</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">gas</span><span class="o">.</span><span class="n">vol_flow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">gas</span><span class="o">.</span><span class="n">setpoint</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dlogger</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dlogger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;G </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gastype</span><span class="p">,</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">vals</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">vals</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">vals</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">val_type</span> <span class="o">==</span> <span class="s1">&#39;temperature&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">indicated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dlogger</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dlogger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;F </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">val_type</span> <span class="o">==</span> <span class="s1">&#39;impedance&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">imp</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">imp</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">val_type</span> <span class="o">==</span> <span class="s1">&#39;thermopower&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">tref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">te1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">te2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">thermo</span><span class="o">.</span><span class="n">volt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dlogger</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dlogger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;T </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">vals</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">vals</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">val_type</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dlogger</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dlogger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;D </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span><span class="s1">&#39;%H:%M.%S_</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">val_type</span> <span class="o">==</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">step_time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dlogger</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dlogger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;S </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span><span class="s1">&#39;%H:%M.%S_</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Setup.shut_down"><a class="viewcode-back" href="../laboratory.html#laboratory.Setup.shut_down">[docs]</a>    <span class="k">def</span> <span class="nf">shut_down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the furnace to a safe temperature and closes ports to both the DAQ and LCR. (TODO need to close ports to motor and furnace)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#TODO save some information about where to start the next file</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Shutting down the lab...&quot;</span><span class="p">)</span>
        <span class="c1"># self.furnace.shutdown()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daq</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcr</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Setup.restart_from_backup"><a class="viewcode-back" href="../laboratory.html#laboratory.Setup.restart_from_backup">[docs]</a>    <span class="k">def</span> <span class="nf">restart_from_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO - reload an aborted experiment and pick up where it left off</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#load the pickle file</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Setup._count_down"><a class="viewcode-back" href="../laboratory.html#laboratory.Setup._count_down">[docs]</a>    <span class="k">def</span> <span class="nf">_count_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">interval</span><span class="p">,</span><span class="n">time_remaining</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Controls the count down until next measurement cycle</span>

<span class="sd">        :param interval: time in seconds remaining until next measurement</span>
<span class="sd">        :type interval: float/int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">time_remaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">time_remaining</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">interval</span><span class="o">*</span><span class="mi">60</span><span class="o">+</span><span class="n">start</span><span class="o">-</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
            <span class="n">mins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_remaining</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span>
            <span class="n">seconds</span> <span class="o">=</span> <span class="n">time_remaining</span><span class="o">%</span><span class="mi">60</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">Next measurement in... </span><span class="si">{:02}</span><span class="s1">m </span><span class="si">{:02}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mins</span><span class="p">,</span><span class="n">seconds</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">time_remaining</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">                                          </span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">),</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="Setup._progress_bar"><a class="viewcode-back" href="../laboratory.html#laboratory.Setup._progress_bar">[docs]</a>    <span class="k">def</span> <span class="nf">_progress_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">iteration</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bar_length</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a terminal progress bar</span>

<span class="sd">        :param iteration: iteration number</span>
<span class="sd">        :type controlfile: int/float</span>

<span class="sd">        :param message: message to be displayed on the right of the progress bar</span>
<span class="sd">        :type message: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span> <span class="k">return</span>   <span class="c1">#don&#39;t display progress bar when in debugging mode</span>

        <span class="n">str_format</span> <span class="o">=</span> <span class="s2">&quot;{0:.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">decimals</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;f}&quot;</span>
        <span class="n">percentage</span> <span class="o">=</span> <span class="n">str_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)))</span>
        <span class="n">filled_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">bar_length</span> <span class="o">*</span> <span class="n">iteration</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)))</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">*</span> <span class="n">filled_length</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">bar_length</span> <span class="o">-</span> <span class="n">filled_length</span><span class="p">)</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">@</span><span class="si">{:0.1f}</span><span class="s1">C |</span><span class="si">{}</span><span class="s1">| </span><span class="si">{}{}</span><span class="s1"> - </span><span class="si">{}</span><span class="s1">             &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_temp</span><span class="p">,</span><span class="n">bar</span><span class="p">,</span> <span class="n">percentage</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span><span class="n">message</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">iteration</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="Setup._break_loop"><a class="viewcode-back" href="../laboratory.html#laboratory.Setup._break_loop">[docs]</a>    <span class="k">def</span> <span class="nf">_break_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">step</span><span class="p">,</span><span class="n">loop_start</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks whether the main measurements loop should be broken in order to proceed to the next step. If temperature is increasing the loop will break once T-indicated exceeds the target temperature. If temperature is decreasing, the loop will break when T-indicated is within 5 degrees of the target. If temperature is holding, the loop will break when the hold time specified by step.hold_length is exceeded.</span>

<span class="sd">        :param step: current measurement step</span>
<span class="sd">        :type param: pd.dataframe</span>

<span class="sd">        :param Tind: current indicated temperature on furnace</span>
<span class="sd">        :type Tind: float</span>

<span class="sd">        :param loop_start: start time of the current measurement cycle</span>
<span class="sd">        :type loop_start: float (time.time())</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#choose when/how to break depending on whether temperatures are increasing, decreasing or holding</span>
        <span class="c1">#if increasing - break when Tind exceeds target_temp</span>
        <span class="n">deltaT</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">target_temp</span> <span class="o">-</span> <span class="n">step</span><span class="o">.</span><span class="n">previous_target</span>
        <span class="k">if</span> <span class="n">step</span><span class="o">.</span><span class="n">target_temp</span> <span class="o">&gt;</span> <span class="n">step</span><span class="o">.</span><span class="n">previous_target</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicated_temp</span> <span class="o">&gt;=</span> <span class="n">step</span><span class="o">.</span><span class="n">target_temp</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">loop_start</span> <span class="o">&gt;=</span> <span class="n">step</span><span class="o">.</span><span class="n">hold_length</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>

        <span class="c1">#if temperature is decreasing, Tind rarely drops below the target - hence the + 5</span>
        <span class="k">elif</span> <span class="n">step</span><span class="o">.</span><span class="n">target_temp</span> <span class="o">&lt;</span> <span class="n">step</span><span class="o">.</span><span class="n">previous_target</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicated_temp</span> <span class="o">&lt;</span> <span class="n">step</span><span class="o">.</span><span class="n">target_temp</span> <span class="o">+</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">loop_start</span> <span class="o">&gt;=</span> <span class="n">step</span><span class="o">.</span><span class="n">hold_length</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">step</span><span class="o">.</span><span class="n">hold_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">loop_start</span> <span class="o">&gt;=</span> <span class="n">step</span><span class="o">.</span><span class="n">hold_length</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="nf">_print_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="p">):</span>
        <span class="c1"># for ind,line in enumerate(step[:-2]):</span>
        <span class="c1">#     if len(step.index[ind]) &gt; 7:</span>
        <span class="c1">#         logger.info(&#39;\t{}\t{}&#39;.format(step.index[ind],line))</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         logger.info(&#39;\t{}\t\t{}&#39;.format(step.index[ind],line))</span>
        <span class="c1"># print(&#39;&#39;)</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;target_temp&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_length&#39;</span><span class="p">,</span> <span class="s1">&#39;heat_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;interval&#39;</span><span class="p">,</span> <span class="s1">&#39;buffer&#39;</span><span class="p">,</span> <span class="s1">&#39;offset&#39;</span><span class="p">,</span> <span class="s1">&#39;fo2_gas&#39;</span><span class="p">,</span> <span class="s1">&#39;est_total_mins&#39;</span><span class="p">]</span>
        <span class="n">column_alias</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Target [C]&#39;</span><span class="p">,</span> <span class="s1">&#39;Hold length [hrs]&#39;</span><span class="p">,</span> <span class="s1">&#39;Heating rate [C/min]&#39;</span><span class="p">,</span> <span class="s1">&#39;Interval&#39;</span><span class="p">,</span> <span class="s1">&#39;Buffer&#39;</span><span class="p">,</span> <span class="s1">&#39;Offset&#39;</span><span class="p">,</span> <span class="s1">&#39;Gas&#39;</span><span class="p">,</span> <span class="s1">&#39;Estimated minutes&#39;</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">column_names</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">column_alias</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">line_width</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Setup.preflight_checklist"><a class="viewcode-back" href="../laboratory.html#laboratory.Setup.preflight_checklist">[docs]</a>    <span class="k">def</span> <span class="nf">preflight_checklist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">controlfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Conducts necessary checks before running an experiment abs</span>

<span class="sd">        :param controlfile: name of control file for the experiment</span>
<span class="sd">        :type controlfile: string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">controlfile</span><span class="p">:</span>  <span class="c1">#check to make sure a control file has been specified</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;You must select a valid control file.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">controlfile</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">controlfile</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">check_controlfile</span><span class="p">(</span><span class="n">controlfile</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Incorrect control file format! Check log file for more details&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">freq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No frequencies have been selected for measurement&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1">#set up the data logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dlogger</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">data_logger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dlogger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;frequencies: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">freq</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dlogger</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">baseFilename</span>

        <span class="c1">#configure instruments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daq</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcr</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">freq</span><span class="p">)</span>

        <span class="c1">#add some useful columns to control file</span>
        <span class="n">controlfile</span><span class="p">[</span><span class="s1">&#39;previous_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">controlfile</span><span class="o">.</span><span class="n">target_temp</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span>
        <span class="n">controlfile</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;previous_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">find_indicated</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">furnace</span><span class="o">.</span><span class="n">setpoint_1</span><span class="p">(),</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">controlfile</span><span class="p">[</span><span class="s1">&#39;previous_heat_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">controlfile</span><span class="o">.</span><span class="n">heat_rate</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span>
        <span class="n">controlfile</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;previous_heat_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">furnace</span><span class="o">.</span><span class="n">heating_rate</span><span class="p">()</span>
        <span class="n">controlfile</span><span class="p">[</span><span class="s1">&#39;est_total_mins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">controlfile</span><span class="o">.</span><span class="n">target_temp</span> <span class="o">-</span> <span class="n">controlfile</span><span class="o">.</span><span class="n">previous_target</span><span class="p">)</span><span class="o">/</span><span class="n">controlfile</span><span class="o">.</span><span class="n">heat_rate</span> <span class="o">+</span> <span class="n">controlfile</span><span class="o">.</span><span class="n">hold_length</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Controlfile:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;target_temp&#39;</span><span class="p">,</span><span class="s1">&#39;hold_length&#39;</span><span class="p">,</span><span class="s1">&#39;heat_rate&#39;</span><span class="p">,</span><span class="s1">&#39;interval&#39;</span><span class="p">,</span><span class="s1">&#39;buffer&#39;</span><span class="p">,</span><span class="s1">&#39;offset&#39;</span><span class="p">,</span><span class="s1">&#39;fo2_gas&#39;</span><span class="p">,</span><span class="s1">&#39;est_total_mins&#39;</span><span class="p">]</span>
        <span class="n">column_alias</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Target [C]&#39;</span><span class="p">,</span><span class="s1">&#39;Hold length [hrs]&#39;</span><span class="p">,</span><span class="s1">&#39;Heating rate [C/min]&#39;</span><span class="p">,</span><span class="s1">&#39;Interval&#39;</span><span class="p">,</span><span class="s1">&#39;Buffer&#39;</span><span class="p">,</span><span class="s1">&#39;Offset&#39;</span><span class="p">,</span><span class="s1">&#39;Gas&#39;</span><span class="p">,</span><span class="s1">&#39;Estimated minutes&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">controlfile</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">column_names</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">column_alias</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">controlfile</span> <span class="o">=</span> <span class="n">controlfile</span>
        <span class="k">return</span> <span class="kc">True</span></div></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="n">lab</span> <span class="o">=</span> <span class="n">Setup</span><span class="p">()</span>
    <span class="n">lab</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;control2.xlsx&#39;</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Laboratory</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../laboratory.html">Module Laboratory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../drivers.html">Module Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data.html">Module Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plotting.html">Module Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../utils.html">Module Utils</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Sam Jennings.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>